<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo - Sorteio e Valida√ß√£o</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(255, 182, 193, 0.3);
            margin-bottom: 30px;
            border: 3px solid #ff69b4;
        }

        .header h1 {
            color: #ff1493;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(255, 20, 147, 0.3);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            color: #8e44ad;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(255, 182, 193, 0.3);
            border: 2px solid #ff69b4;
        }

        .section h2 {
            color: #ff1493;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(255, 20, 147, 0.2);
        }

        .sorteio-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 20, 147, 0.4);
        }

        .stat-box .number {
            font-size: 2em;
            display: block;
        }

        .stat-box .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .controles-sorteio {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .btn {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 20, 147, 0.4);
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 20, 147, 0.6);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .item-sorteado {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.4em;
            font-weight: bold;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(255, 20, 147, 0.4);
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lista-itens {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 10px;
            border: 2px solid #ff69b4;
            text-align: center;
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
        }

        .item.sorteado {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-color: #28a745;
        }

        /* Se√ß√£o do Scanner */
        .scanner-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #scanner-video {
            width: 100%;
            max-width: 400px;
            border: 2px solid #ff69b4;
            border-radius: 10px;
            margin: 10px auto;
            background: #f8f9fa;
            display: block;
        }

        .scanner-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .scanner-feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }

        .resultado-validacao {
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            display: none;
        }

        .resultado-validacao.vencedor {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .resultado-validacao.perdedor {
            background: linear-gradient(135deg, #dc3545, #e91e63);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        .cartela-info {
            background: #f8f9fa;
            border: 2px solid #ff69b4;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .cartela-info h4 {
            color: #ff1493;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .controles-sorteio {
                flex-direction: column;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .lista-itens {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≤ Sorteio e Valida√ß√£o</h1>
            <p>Ch√° de Panela da Mari - Sistema de Bingo</p>
        </div>

        <div class="content">
            <!-- Se√ß√£o de Sorteio -->
            <div class="section">
                <h2>üé≤ Sorteio de Itens</h2>
                <div class="sorteio-area">
                    <div class="stats">
                        <div class="stat-box">
                            <span class="number" id="totalItens">0</span>
                            <span class="label">Total de Itens</span>
                        </div>
                        <div class="stat-box">
                            <span class="number" id="itensSorteadosCount">0</span>
                            <span class="label">J√° Sorteados</span>
                        </div>
                    </div>

                    <div class="controles-sorteio">
                        <button class="btn" id="btnSortear" onclick="sortearProximoItem()">üé∞ Sortear Item</button>
                        <button class="btn" id="btnReiniciar" onclick="reiniciarSorteio()">üîÑ Reiniciar Sorteio</button>
                    </div>

                    <div class="item-sorteado" id="itemSorteado">
                        Clique em "Sortear Item" para come√ßar!
                    </div>

                    <div class="lista-itens" id="listaItens">
                        <!-- Itens ser√£o carregados aqui -->
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Valida√ß√£o -->
            <div class="section">
                <h2>üì± Valida√ß√£o de Cartela</h2>
                <div class="scanner-container">
                    <div class="scanner-controls">
                        <button class="btn" id="btnIniciarScanner" onclick="iniciarScanner()">üì∑ Iniciar Scanner</button>
                        <button class="btn" id="btnPararScanner" onclick="pararScanner()" style="display: none;">‚èπÔ∏è Parar Scanner</button>
                    </div>
                    
                    <video id="scanner-video" style="display: none;" autoplay playsinline></video>
                    
                    <div class="scanner-feedback" id="scannerFeedback" style="display: none;">
                        Posicione o QR Code da cartela na frente da c√¢mera
                    </div>

                    <div class="resultado-validacao" id="resultadoValidacao"></div>
                    <div class="cartela-info" id="cartelaInfo"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Itens do bingo - mesmo array do script principal
        const itensBingo = [
            // Utens√≠lios de Cozinha
            'Panela de press√£o', 'Frigideira antiaderente', 'Conjunto de panelas', 'Chaleira el√©trica',
            'Liquidificador', 'Batedeira', 'Mixer', 'Processador de alimentos',
            'Espremedor de frutas', 'Centr√≠fuga de salada', 'Peneira', 'Escorredor de macarr√£o',
            'T√°bua de corte', 'Conjunto de facas', 'Amolador de facas', 'Descascador de legumes',
            'Ralador multiuso', 'Cortador de pizza', 'Abrelatas', 'Saca-rolhas',
            'Concha', 'Escumadeira', 'Esp√°tula', 'Batedor de ovos manual',
            'Pegador de salada', 'Pegador de gelo', 'Funil', 'Medidor de l√≠quidos',

            // Utens√≠lios de Mesa e Servir
            'Jogo de pratos', 'Conjunto de talheres', 'Ta√ßas de vinho', 'Copos de vidro',
            'Jarra de vidro', 'Travessa de servir', 'Saladeira', 'Fruteira',
            'A√ßucareiro', 'Leiteira', 'Manteigueira', 'Porta-guardanapos',
            'Sousplat', 'Jogo americano', 'Toalha de mesa', 'Guardanapos de tecido',

            // Utens√≠lios para Assar e Cozinhar
            'Forma de bolo', 'Forma de p√£o', 'Assadeira', 'Refrat√°rios',
            'Forma de pizza', 'Forma de torta', 'Forminhas de empada', 'Rolo de macarr√£o',
            'Peneira de farinha', 'Balan√ßa de cozinha', 'Timer de cozinha', 'Term√¥metro culin√°rio',

            // Armazenamento
            'Potes de vidro', 'Conjunto de potes pl√°sticos', 'Porta-temperos', 'Lata de mantimentos',
            'Garrafa t√©rmica', 'Marmiteiro', 'Pote de sorvete', 'Forma de gelo',

            // Limpeza de Cozinha
            'Toalhas de prato', 'Panos de microfibra', 'Esponjas especiais', 'Luvas de lavar lou√ßa',
            'Sabonete l√≠quido', 'Porta-detergente', 'Escova para garrafas', 'Rodo de pia',

            // Eletrodom√©sticos Pequenos
            'Torradeira', 'Sanduicheira', 'Grill el√©trico', 'Fritadeira el√©trica',
            'Cafeteira', 'Micro-ondas', 'Forno el√©trico', 'Cooktop port√°til',

            // Decora√ß√£o da Cozinha
            'Cortina para cozinha', 'Tapete de cozinha', 'Rel√≥gio de parede', 'Quadros decorativos',
            'Vasos para ervas', 'Lumin√°ria pendente', 'Porta-recados', '√çm√£s de geladeira'
        ];

        // Estado do sorteio
        let itensSorteados = [];
        let itensDisponiveis = [...itensBingo];

        // Scanner variables
        let stream = null;
        let scanning = false;
        let scannerInterval = null;

        // Inicializar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üé≤ P√°gina carregada, inicializando...');
            atualizarInterface();
            carregarItens();
        });

        // Carregar e exibir todos os itens
        function carregarItens() {
            console.log('üìã Carregando lista de itens...');
            const listaContainer = document.getElementById('listaItens');
            listaContainer.innerHTML = '';

            itensBingo.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.textContent = item;
                
                if (itensSorteados.includes(item)) {
                    itemDiv.classList.add('sorteado');
                }
                
                listaContainer.appendChild(itemDiv);
            });
            
            console.log('üìã Lista carregada com', itensBingo.length, 'itens');
        }

        // Sortear pr√≥ximo item
        function sortearProximoItem() {
            console.log('üé∞ Tentando sortear item...');
            
            if (itensDisponiveis.length === 0) {
                alert('üéâ Todos os itens j√° foram sorteados!');
                return;
            }

            const indiceAleatorio = Math.floor(Math.random() * itensDisponiveis.length);
            const itemSorteado = itensDisponiveis[indiceAleatorio];

            // Remover item da lista dispon√≠vel e adicionar aos sorteados
            itensDisponiveis.splice(indiceAleatorio, 1);
            itensSorteados.push(itemSorteado);

            // Atualizar interface
            document.getElementById('itemSorteado').textContent = itemSorteado;
            atualizarInterface();
            carregarItens();

            console.log('üé≤ Item sorteado:', itemSorteado);
            console.log('üìä Total sorteados:', itensSorteados.length);
            console.log('üìä Restam:', itensDisponiveis.length);
        }

        // Reiniciar sorteio
        function reiniciarSorteio() {
            console.log('üîÑ Solicitando reinicializa√ß√£o...');
            
            if (confirm('üîÑ Tem certeza que deseja reiniciar o sorteio? Todos os itens sorteados ser√£o resetados.')) {
                itensSorteados = [];
                itensDisponiveis = [...itensBingo];
                
                document.getElementById('itemSorteado').textContent = 'Clique em "Sortear Item" para come√ßar!';
                atualizarInterface();
                carregarItens();
                
                console.log('üîÑ Sorteio reiniciado');
            }
        }

        // Atualizar estat√≠sticas da interface
        function atualizarInterface() {
            console.log('üîÑ Atualizando interface...');
            
            document.getElementById('totalItens').textContent = itensBingo.length;
            document.getElementById('itensSorteadosCount').textContent = itensSorteados.length;
            
            const btnSortear = document.getElementById('btnSortear');
            btnSortear.disabled = itensDisponiveis.length === 0;
            
            if (itensDisponiveis.length === 0) {
                btnSortear.textContent = 'üéâ Sorteio Completo!';
            } else {
                btnSortear.textContent = 'üé∞ Sortear Item';
            }
            
            console.log('üîÑ Interface atualizada');
        }

        // ========== VALIDA√á√ÉO DE CARTELAS ==========

        // Iniciar scanner
        async function iniciarScanner() {
            try {
                console.log('üì∑ Iniciando scanner...');
                
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('scanner-video');
                video.srcObject = stream;
                
                video.style.display = 'block';
                document.getElementById('scannerFeedback').style.display = 'block';
                document.getElementById('btnIniciarScanner').style.display = 'none';
                document.getElementById('btnPararScanner').style.display = 'inline-block';
                
                scanning = true;
                iniciarDeteccaoQR(video);
                
                console.log('üì∑ Scanner iniciado com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao iniciar scanner:', error);
                alert('Erro ao acessar a c√¢mera. Verifique as permiss√µes.');
            }
        }

        // Parar scanner
        function pararScanner() {
            console.log('‚èπÔ∏è Parando scanner...');
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            scanning = false;
            if (scannerInterval) {
                clearInterval(scannerInterval);
                scannerInterval = null;
            }
            
            const video = document.getElementById('scanner-video');
            video.style.display = 'none';
            document.getElementById('scannerFeedback').style.display = 'none';
            document.getElementById('btnIniciarScanner').style.display = 'inline-block';
            document.getElementById('btnPararScanner').style.display = 'none';
            
            console.log('üì∑ Scanner parado');
        }

        // Detectar QR Code
        function iniciarDeteccaoQR(video) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            scannerInterval = setInterval(() => {
                if (!scanning || video.videoWidth === 0 || video.videoHeight === 0) {
                    return;
                }

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const qrCode = jsQR(imageData.data, canvas.width, canvas.height);

                if (qrCode) {
                    console.log('üì± QR Code detectado:', qrCode.data);
                    pararScanner();
                    validarCartela(qrCode.data);
                }
            }, 100);
        }

        // Validar cartela atrav√©s do QR Code
        function validarCartela(dadosQR) {
            try {
                console.log('üîç Dados recebidos para valida√ß√£o:', dadosQR);
                
                let cartelaId = dadosQR;
                let dadosCartela = null;
                
                // VERIFICAR SE √â UM ID SIMPLES (novo sistema)
                if (typeof dadosQR === 'string' && dadosQR.match(/^MARI\d+/)) {
                    console.log('üì± Detectado ID de cartela:', cartelaId);
                    
                    // CARREGAR BASE DE DADOS DO LOCALSTORAGE
                    const database = JSON.parse(localStorage.getItem('cartelasDatabase') || '{}');
                    console.log('üìä Base de dados carregada:', Object.keys(database).length, 'cartelas');
                    
                    // BUSCAR DADOS DA CARTELA
                    dadosCartela = database[cartelaId];
                    
                    if (!dadosCartela) {
                        throw new Error(`Cartela com ID "${cartelaId}" n√£o encontrada na base de dados. Certifique-se de que as cartelas foram geradas nesta sess√£o.`);
                    }
                    
                    console.log('‚úÖ Cartela encontrada na base:', dadosCartela);
                    
                } else {
                    // TENTAR SISTEMA ANTIGO (JSON)
                    try {
                        dadosCartela = JSON.parse(dadosQR);
                        cartelaId = dadosCartela.hash || `Cartela-${dadosCartela.numero}`;
                        console.log('üìã Dados da cartela (sistema antigo):', dadosCartela);
                    } catch (parseError) {
                        throw new Error('QR Code n√£o √© um ID v√°lido nem cont√©m dados JSON v√°lidos');
                    }
                }

                console.log('üîí Analisando cartela...');
                console.log('üé≤ Itens sorteados at√© agora:', itensSorteados);
                console.log('üìã Itens da cartela:', dadosCartela.itens);

                // Verificar se √© uma cartela vencedora
                const itensCartela = dadosCartela.itens;
                const itensCartelaSorteados = itensCartela.filter(item => itensSorteados.includes(item));
                const itensNaoSorteados = itensCartela.filter(item => !itensSorteados.includes(item));
                const isVencedor = itensNaoSorteados.length === 0;
                
                console.log('üìä An√°lise da cartela:', {
                    totalItens: itensCartela.length,
                    itensSorteados: itensCartelaSorteados.length,
                    itensRestantes: itensNaoSorteados.length,
                    vencedor: isVencedor
                });

                // Mostrar resultado
                const resultadoDiv = document.getElementById('resultadoValidacao');
                const cartelaInfoDiv = document.getElementById('cartelaInfo');
                
                if (resultadoDiv) resultadoDiv.style.display = 'block';
                if (cartelaInfoDiv) cartelaInfoDiv.style.display = 'block';

                if (isVencedor) {
                    if (resultadoDiv) {
                        resultadoDiv.className = 'resultado-validacao vencedor';
                        resultadoDiv.innerHTML = 'üéâ CARTELA VENCEDORA! üéâ<br>BINGO V√ÅLIDO!';
                    }
                    
                    // Vibrar se dispon√≠vel
                    if ('vibrate' in navigator) {
                        navigator.vibrate([200, 100, 200, 100, 200]);
                    }
                    
                } else {
                    if (resultadoDiv) {
                        resultadoDiv.className = 'resultado-validacao perdedor';
                        resultadoDiv.innerHTML = `‚ùå Cartela ainda n√£o vencedora<br>Faltam ${itensNaoSorteados.length} item(ns)`;
                    }
                }

                // Mostrar informa√ß√µes detalhadas da cartela
                if (cartelaInfoDiv) {
                    const progressoCartela = Math.round((itensCartelaSorteados.length / itensCartela.length) * 100);
                    
                    cartelaInfoDiv.innerHTML = `
                        <h4>üìã Cartela ${dadosCartela.numero} - Detalhes</h4>
                        <p><strong>üÜî ID:</strong> ${cartelaId}</p>
                        
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <h5 style="margin: 0 0 10px 0; color: #4caf50;">‚úÖ Itens j√° sorteados (${itensCartelaSorteados.length}/${itensCartela.length})</h5>
                            <div style="font-size: 14px; color: #2e7d32;">
                                ${itensCartelaSorteados.length > 0 ? itensCartelaSorteados.map(item => `<span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; margin: 2px; display: inline-block;">${item}</span>`).join(' ') : '<em>Nenhum item sorteado ainda</em>'}
                            </div>
                        </div>
                        
                        ${itensNaoSorteados.length > 0 ? `
                        <div style="background: #ffeaea; padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <h5 style="margin: 0 0 10px 0; color: #e91e63;">‚è≥ Itens ainda n√£o sorteados (${itensNaoSorteados.length})</h5>
                            <div style="font-size: 14px; color: #c62828;">
                                ${itensNaoSorteados.map(item => `<span style="background: #e91e63; color: white; padding: 2px 6px; border-radius: 3px; margin: 2px; display: inline-block;">${item}</span>`).join(' ')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <p><strong>üìä Progresso:</strong> ${progressoCartela}% completa</p>
                            <p><strong>üé™ Evento:</strong> ${dadosCartela.evento || 'Ch√° de Panela da Mari'}</p>
                            <p><strong>üìÖ Gerada em:</strong> ${dadosCartela.criadaEm ? new Date(dadosCartela.criadaEm).toLocaleString('pt-BR') : 'N/A'}</p>
                            <p><strong>üé≤ Total de itens sorteados no jogo:</strong> ${itensSorteados.length}</p>
                        </div>
                    `;
                }

                console.log('‚úÖ Valida√ß√£o conclu√≠da com sucesso!');

            } catch (error) {
                console.error('‚ùå Erro na valida√ß√£o:', error);
                
                const resultadoDiv = document.getElementById('resultadoValidacao');
                const cartelaInfoDiv = document.getElementById('cartelaInfo');
                
                if (resultadoDiv) {
                    resultadoDiv.style.display = 'block';
                    resultadoDiv.className = 'resultado-validacao perdedor';
                    resultadoDiv.innerHTML = `‚ùå Erro na valida√ß√£o<br>${error.message}`;
                }
                
                if (cartelaInfoDiv) {
                    cartelaInfoDiv.style.display = 'block';
                    cartelaInfoDiv.innerHTML = `
                        <h4>‚ö†Ô∏è Erro na Valida√ß√£o</h4>
                        <p style="color: #e91e63;">${error.message}</p>
                        <p><strong>Dica:</strong> Certifique-se de que:</p>
                        <ul>
                            <li>As cartelas foram geradas na mesma sess√£o/navegador</li>
                            <li>O QR Code √© de uma cartela v√°lida deste jogo</li>
                            <li>O QR Code n√£o est√° danificado</li>
                        </ul>
                        <p><strong>Dados recebidos:</strong></p>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 12px; overflow-x: auto; max-height: 100px;">${dadosQR}</pre>
                        
                        <p><strong>Base de dados dispon√≠vel:</strong></p>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 12px; overflow-x: auto;">${Object.keys(JSON.parse(localStorage.getItem('cartelasDatabase') || '{}')).join(', ') || 'Nenhuma cartela encontrada'}</pre>
                    `;
                }
            }
        }
    </script>
</body>
</html>
