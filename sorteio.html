<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteio e Valida√ß√£o - Bingo da Mari</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #e91e63, #f06292);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ff4081, #e91e63);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.3);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.secondary {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
        }

        .item-sorteado {
            background: linear-gradient(135deg, #9c27b0, #ba68c8);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.3);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lista-itens {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .item.sorteado {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            border-color: #4caf50;
            transform: scale(1.02);
        }

        .scanner-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        .scanner-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        #scanner-video {
            width: 100%;
            max-width: 400px;
            border: 3px solid #e91e63;
            border-radius: 15px;
            display: none;
        }

        .resultado-validacao {
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-weight: bold;
            display: none;
        }

        .resultado-validacao.vencedor {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
        }

        .resultado-validacao.perdedor {
            background: linear-gradient(135deg, #f44336, #ef5350);
            color: white;
        }

        .cartela-info {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e0e0e0;
            display: none;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .lista-itens {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≤ Sorteio e Valida√ß√£o</h1>
            <p>Ch√° de Panela da Mari - Sistema de Bingo</p>
        </div>

        <div class="content">
            <!-- Estat√≠sticas -->
            <div class="stats">
                <div class="stat-card">
                    <span class="stat-number" id="totalItens">0</span>
                    <span class="stat-label">Total de Itens</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="itensSorteados">0</span>
                    <span class="stat-label">Itens Sorteados</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="itensRestantes">0</span>
                    <span class="stat-label">Itens Restantes</span>
                </div>
            </div>

            <!-- Controles -->
            <div class="controls">
                <button id="sortearItem" class="btn">üé≤ Sortear Item</button>
                <button id="reiniciarSorteio" class="btn secondary">üîÑ Reiniciar Sorteio</button>
            </div>

            <!-- Item sorteado -->
            <div class="item-sorteado" id="itemSorteado">
                Clique em "Sortear Item" para come√ßar!
            </div>

            <!-- Lista de itens -->
            <h3>üìã Lista de Itens</h3>
            <div class="lista-itens" id="listaItens">
                <!-- Itens ser√£o carregados aqui -->
            </div>

            <!-- Scanner de QR Code -->
            <div class="scanner-section">
                <h3>üì± Valida√ß√£o de Cartela</h3>
                <div class="scanner-controls">
                    <button id="iniciarScanner" class="btn">üì∑ Iniciar Scanner</button>
                    <button id="pararScanner" class="btn secondary" style="display: none;">‚èπÔ∏è Parar Scanner</button>
                </div>
                
                <video id="scanner-video" autoplay playsinline></video>
                
                <div class="resultado-validacao" id="resultadoValidacao"></div>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ Carregando sistema de sorteio...');
        

// Array padronizado igual ao script.js
const itensCozinha = [
    { chave: 1, nome: "Garfo" },
    { chave: 2, nome: "Faca" },
    { chave: 3, nome: "Colher" },
    { chave: 4, nome: "Colher de ch√°" },
    { chave: 5, nome: "Faca de p√£o" },
    { chave: 6, nome: "Garfo de sobremesa" },
    { chave: 7, nome: "Panela de press√£o" },
    { chave: 8, nome: "Panela" },
    { chave: 9, nome: "Frigideira" },
    { chave: 10, nome: "Ca√ßarola" },
    { chave: 11, nome: "Leiteira" },
    { chave: 12, nome: "Chaleira" },
    { chave: 13, nome: "Concha" },
    { chave: 14, nome: "Escumadeira" },
    { chave: 15, nome: "Esp√°tula" },
    { chave: 16, nome: "Colher de pau" },
    { chave: 17, nome: "Batedor de ovos" },
    { chave: 18, nome: "Pegador" },
    { chave: 19, nome: "Abridor de latas" },
    { chave: 20, nome: "Saca-rolhas" },
    { chave: 21, nome: "Descascador" },
    { chave: 22, nome: "Ralador" },
    { chave: 23, nome: "Peneira" },
    { chave: 24, nome: "Coador" },
    { chave: 25, nome: "T√°bua de corte" },
    { chave: 26, nome: "Rolo de massa" },
    { chave: 27, nome: "Funil" },
    { chave: 28, nome: "Assadeira" },
    { chave: 29, nome: "Forma de bolo" },
    { chave: 30, nome: "Forma de pizza" },
    { chave: 31, nome: "Forma de p√£o" },
    { chave: 32, nome: "Refrat√°rio" },
    { chave: 33, nome: "Liquidificador" },
    { chave: 34, nome: "Batedeira" },
    { chave: 35, nome: "Torradeira" },
    { chave: 36, nome: "Cafeteira" },
    { chave: 37, nome: "Micro-ondas" },
    { chave: 38, nome: "Mixer" },
    { chave: 39, nome: "Tigela" },
    { chave: 40, nome: "Jarra" },
    { chave: 41, nome: "Potes" },
    { chave: 42, nome: "Tupperware" },
    { chave: 43, nome: "Garrafa t√©rmica" },
    { chave: 44, nome: "Pratos" },
    { chave: 45, nome: "X√≠caras" },
    { chave: 46, nome: "Copos" },
    { chave: 47, nome: "Canecas" },
    { chave: 48, nome: "Travessa" },
    { chave: 49, nome: "A√ßucareiro" },
    { chave: 50, nome: "Bule" },
    { chave: 51, nome: "Balan√ßa" },
    { chave: 52, nome: "X√≠caras medidoras" },
    { chave: 53, nome: "Timer" },
    { chave: 54, nome: "Avental" },
    { chave: 55, nome: "Luvas de forno" },
    { chave: 56, nome: "Panos de prato" },
    { chave: 57, nome: "Escorredor de lou√ßas" },
    { chave: 58, nome: "Porta-talheres" },
    { chave: 59, nome: "Descanso de panela" },
    { chave: 60, nome: "Guardanapos" },
    { chave: 61, nome: "Papel toalha" },
    { chave: 62, nome: "Papel alum√≠nio" },
    { chave: 63, nome: "Filme pl√°stico" }
];

// Fun√ß√£o para obter nome pelo chave
function obterItemDaChave(chave) {
    const obj = itensCozinha.find(item => item.chave === Number(chave));
    return obj ? obj.nome : null;
}

// Fun√ß√£o para obter chave pelo nome
function obterChaveItem(nome) {
    const obj = itensCozinha.find(item => item.nome === nome);
    return obj ? obj.chave : null;
}

// Deriva o array de nomes para o bingo
const itensBingo = itensCozinha.map(item => item.nome);

// Estado do jogo
let itensSorteados = [];
let itensDisponiveis = [...itensBingo];

// Estado do scanner
let stream = null;
let scanning = false;
let scannerInterval = null;

        // Aguardar carregamento da p√°gina
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarSistema);
        } else {
            inicializarSistema();
        }

        function inicializarSistema() {
            console.log('üé≤ Inicializando sistema de sorteio...');
            
            // Verificar se elementos existem
            const sortearBtn = document.getElementById('sortearItem');
            const reiniciarBtn = document.getElementById('reiniciarSorteio');
            
            if (!sortearBtn || !reiniciarBtn) {
                console.error('‚ùå Elementos n√£o encontrados!');
                return;
            }
            
            console.log('‚úÖ Elementos encontrados, configurando...');
            
            inicializar();
            configurarEventListeners();
        }

        function inicializar() {
            console.log('üìä Carregando dados iniciais...');
            carregarItens();
            atualizarEstatisticas();
            carregarEstadoSorteio();
            console.log('‚úÖ Sistema inicializado com sucesso!');
        }

        function configurarEventListeners() {
            console.log('üîó Configurando event listeners...');
            
            const sortearBtn = document.getElementById('sortearItem');
            const reiniciarBtn = document.getElementById('reiniciarSorteio');
            const iniciarScannerBtn = document.getElementById('iniciarScanner');
            const pararScannerBtn = document.getElementById('pararScanner');
            
            if (sortearBtn) {
                sortearBtn.addEventListener('click', function() {
                    console.log('üé≤ Bot√£o sortear clicado!');
                    sortearItem();
                });
                console.log('‚úÖ Event listener do sortear configurado');
            }
            
            if (reiniciarBtn) {
                reiniciarBtn.addEventListener('click', function() {
                    console.log('üîÑ Bot√£o reiniciar clicado!');
                    reiniciarSorteio();
                });
                console.log('‚úÖ Event listener do reiniciar configurado');
            }
            
            if (iniciarScannerBtn) {
                iniciarScannerBtn.addEventListener('click', function() {
                    console.log('üì∑ Bot√£o iniciar scanner clicado!');
                    iniciarScanner();
                });
                console.log('‚úÖ Event listener do scanner configurado');
            }
            
            if (pararScannerBtn) {
                pararScannerBtn.addEventListener('click', function() {
                    console.log('‚èπÔ∏è Bot√£o parar scanner clicado!');
                    pararScanner();
                });
                console.log('‚úÖ Event listener do parar scanner configurado');
            }
            
            console.log('üéØ Todos os event listeners configurados!');
        }

        function carregarItens() {
            console.log('üìã Carregando lista de itens...');
            const container = document.getElementById('listaItens');
            
            if (!container) {
                console.error('‚ùå Container da lista n√£o encontrado!');
                return;
            }
            
            container.innerHTML = '';

            itensBingo.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'item';
                div.textContent = item;
                
                if (itensSorteados.includes(item)) {
                    div.classList.add('sorteado');
                }
                
                container.appendChild(div);
            });
            
            console.log(`‚úÖ ${itensBingo.length} itens carregados na lista`);
        }

        function atualizarEstatisticas() {
            console.log('üìà Atualizando estat√≠sticas...');
            
            const totalElement = document.getElementById('totalItens');
            const sorteadosElement = document.getElementById('itensSorteados');
            const restantesElement = document.getElementById('itensRestantes');
            
            if (totalElement) totalElement.textContent = itensBingo.length;
            if (sorteadosElement) sorteadosElement.textContent = itensSorteados.length;
            if (restantesElement) restantesElement.textContent = itensDisponiveis.length;
            
            const btnSortear = document.getElementById('sortearItem');
            if (btnSortear) {
                btnSortear.disabled = itensDisponiveis.length === 0;
                
                if (itensDisponiveis.length === 0) {
                    btnSortear.textContent = 'üéâ Sorteio Completo!';
                } else {
                    btnSortear.textContent = 'üé≤ Sortear Item';
                }
            }
            
            console.log(`üìä Stats: ${itensSorteados.length}/${itensBingo.length} sorteados`);
        }

        function sortearItem() {
            console.log('üé≤ Executando sorteio...');
            
            if (itensDisponiveis.length === 0) {
                alert('üéâ Todos os itens j√° foram sorteados!');
                console.log('‚ö†Ô∏è Tentativa de sorteio com lista vazia');
                return;
            }

            const indice = Math.floor(Math.random() * itensDisponiveis.length);
            const item = itensDisponiveis[indice];

            itensDisponiveis.splice(indice, 1);
            itensSorteados.push(item);

            const itemElement = document.getElementById('itemSorteado');
            if (itemElement) {
                itemElement.textContent = item;
            }
            
            carregarItens();
            atualizarEstatisticas();
            salvarEstadoSorteio();

            console.log(`üéØ Item sorteado: "${item}"`);
            
            // Feedback visual
            if ('vibrate' in navigator) {
                navigator.vibrate(100);
            }
        }

        function reiniciarSorteio() {
            console.log('üîÑ Tentando reiniciar sorteio...');
            
            if (confirm('üîÑ Tem certeza que deseja reiniciar o sorteio?')) {
                itensSorteados = [];
                itensDisponiveis = [...itensBingo];
                
                const itemElement = document.getElementById('itemSorteado');
                if (itemElement) {
                    itemElement.textContent = 'Clique em "Sortear Item" para come√ßar!';
                }
                
                carregarItens();
                atualizarEstatisticas();
                salvarEstadoSorteio();
                
                console.log('‚úÖ Sorteio reiniciado com sucesso!');
            } else {
                console.log('‚ùå Rein√≠cio cancelado pelo usu√°rio');
            }
        }

        function salvarEstadoSorteio() {
            try {
                const estado = {
                    itensSorteados: itensSorteados,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('bingoSorteio', JSON.stringify(estado));
                console.log('üíæ Estado do sorteio salvo');
            } catch (error) {
                console.error('‚ùå Erro ao salvar estado:', error);
            }
        }

        function carregarEstadoSorteio() {
            try {
                const estado = localStorage.getItem('bingoSorteio');
                if (estado) {
                    const dados = JSON.parse(estado);
                    itensSorteados = dados.itensSorteados || [];
                    itensDisponiveis = itensBingo.filter(item => !itensSorteados.includes(item));
                    
                    if (itensSorteados.length > 0) {
                        const itemElement = document.getElementById('itemSorteado');
                        if (itemElement) {
                            itemElement.textContent = itensSorteados[itensSorteados.length - 1];
                        }
                    }
                    
                    console.log(`üìä Estado carregado: ${itensSorteados.length} itens sorteados`);
                } else {
                    console.log('üìã Nenhum estado salvo encontrado');
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar estado:', error);
            }
        }

        // ========== SCANNER QR CODE ==========

        async function iniciarScanner() {
            try {
                console.log('üì∑ Iniciando scanner...');
                // Solicita alta resolu√ß√£o e c√¢mera traseira
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                const video = document.getElementById('scanner-video');
                if (video) {
                    video.srcObject = stream;
                    video.style.display = 'block';
                    video.setAttribute('playsinline', 'true'); // iOS Safari
                    video.setAttribute('autoplay', 'true');
                    video.setAttribute('muted', 'true');
                    // Ajusta tamanho responsivo
                    video.style.width = '100%';
                    video.style.maxWidth = '400px';
                    video.style.height = 'auto';
                }

                // Orienta√ß√£o para o usu√°rio
                const resultadoDiv = document.getElementById('resultadoValidacao');
                if (resultadoDiv) {
                    resultadoDiv.style.display = 'block';
                    resultadoDiv.className = 'resultado-validacao';
                    resultadoDiv.innerHTML = 'Aponte a c√¢mera para o QR Code da cartela. D√™ permiss√£o para a c√¢mera e mantenha o QR centralizado e focado.';
                }

                const iniciarBtn = document.getElementById('iniciarScanner');
                const pararBtn = document.getElementById('pararScanner');

                if (iniciarBtn) iniciarBtn.style.display = 'none';
                if (pararBtn) pararBtn.style.display = 'inline-block';

                scanning = true;
                detectarQRCode(video);

                console.log('‚úÖ Scanner iniciado com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao iniciar scanner:', error);
                alert('Erro ao acessar a c√¢mera: ' + error.message + '\nVerifique se o navegador tem permiss√£o para usar a c√¢mera.');
            }
        }

        function pararScanner() {
            console.log('‚èπÔ∏è Parando scanner...');
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            scanning = false;
            if (scannerInterval) {
                clearInterval(scannerInterval);
                scannerInterval = null;
            }
            
            const video = document.getElementById('scanner-video');
            const iniciarBtn = document.getElementById('iniciarScanner');
            const pararBtn = document.getElementById('pararScanner');
            
            if (video) video.style.display = 'none';
            if (iniciarBtn) iniciarBtn.style.display = 'inline-block';
            if (pararBtn) pararBtn.style.display = 'none';
            
            console.log('‚úÖ Scanner parado');
        }

        function detectarQRCode(video) {
            if (!video) {
                console.error('‚ùå Elemento de v√≠deo n√£o encontrado');
                return;
            }
            
            // Canvas para capturar o frame do v√≠deo
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            scannerInterval = setInterval(() => {
                if (!scanning || !video || video.readyState !== video.HAVE_ENOUGH_DATA) return;

                // Ajusta o canvas para o tamanho do v√≠deo
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

                if (typeof jsQR !== 'undefined') {
                    const qrCode = jsQR(imageData.data, canvas.width, canvas.height);
                    if (qrCode) {
                        console.log('üì± QR Code detectado:', qrCode.data);
                        pararScanner();
                        validarCartela(qrCode.data);
                    }
                } else {
                    console.error('‚ùå Biblioteca jsQR n√£o carregada');
                }
            }, 200); // 200ms para melhor responsividade
        }

        function validarCartela(dadosQR) {
            try {
                // QR code √© uma string simples com chaves num√©ricas: "1,2,3,4,5..."
                const chavesNumericas = dadosQR.split(',').map(chave => parseInt(chave.trim())).filter(chave => !isNaN(chave));
                
                // Converter chaves num√©ricas para palavras
                const itensCartela = chavesNumericas.map(chave => obterItemDaChave(chave)).filter(item => item);
                
                // Verificar quais palavras ainda n√£o foram sorteadas
                const palavrasFaltando = itensCartela.filter(palavra => !itensSorteados.includes(palavra));
                const isBingo = palavrasFaltando.length === 0;

                // MOSTRAR RESULTADO SIMPLES E DIRETO
                const resultadoDiv = document.getElementById('resultadoValidacao');
                
                if (resultadoDiv) {
                    resultadoDiv.style.display = 'block';
                    
                    if (isBingo) {
                        resultadoDiv.className = 'resultado-validacao vencedor';
                        resultadoDiv.innerHTML = 'üéâüéâüéâ BINGOOOOO! üéâüéâüéâ<br><strong>CARTELA VENCEDORA!</strong>';
                        
                        // Vibra√ß√£o no celular se dispon√≠vel
                        if ('vibrate' in navigator) {
                            navigator.vibrate([300, 100, 300, 100, 300]);
                        }
                    } else {
                        resultadoDiv.className = 'resultado-validacao perdedor';
                        resultadoDiv.innerHTML = `‚ùå <strong>N√ÉO √â BINGO</strong><br>Faltam ${palavrasFaltando.length} palavra(s):<br><strong>${palavrasFaltando.join(', ')}</strong>`;
                    }
                }

            } catch (error) {
                const resultadoDiv = document.getElementById('resultadoValidacao');
                if (resultadoDiv) {
                    resultadoDiv.style.display = 'block';
                    resultadoDiv.className = 'resultado-validacao perdedor';
                    resultadoDiv.innerHTML = `‚ùå <strong>QR Code inv√°lido</strong><br>N√£o foi poss√≠vel ler as palavras da cartela`;
                }
            }
        }

        // Debug para verificar se o script carregou
        console.log('‚úÖ Script carregado completamente!');
    </script>
</body>
</html>
